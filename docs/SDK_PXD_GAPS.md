# SDK PXD Gaps Documentation

This document catalogs the gaps between auto-generated SDK `.pxd` files and the manual `_chexrays.pxd` definitions, enabling future improvements to the pxd generator.

> **Last Updated**: 2025-11-30

## Overview

D810's Cython bindings use two approaches:

1. **Auto-generated SDK files** (`src/d810/speedups/cythxr/sdk/`)
   - Generated by `pxdgen` from IDA SDK headers
   - Contain basic type definitions and class stubs
   - May have incomplete methods, wrong signatures, or missing fields

2. **Manual definitions** (`src/d810/speedups/cythxr/_chexrays.pxd`)
   - Hand-crafted to fill gaps in SDK files
   - Contains full template definitions, custom helpers, and fixes
   - Currently required for correct Cython compilation

## Current Status Summary

| Gap Category | Status | Notes |
|--------------|--------|-------|
| Template classes (qvector, _qstring) | ✅ FIXED | SDK now has ~20 methods each |
| mop_t class definition | ✅ FIXED | SDK now has full class with all fields and methods |
| mcallinfo_t.args field | ✅ FIXED | SDK now includes `mcallargs_t args` field |
| MOPT enum (mop_zero, mop_r, etc.) | Manual by design | SDK correctly uses `ctypedef uint8 mopt_t`; named constants are Cython convenience |
| OPERAND_PROPERTIES enum | Manual by design | SDK exposes `oprops` field; named enum is Cython convenience |
| LOCOPT_FLAGS enum | Manual by design | Named enum is Cython convenience |
| SWIG helpers | Manual by design | Cannot be auto-generated |

## Gap Categories

### 1. Template Class Definitions ✅ FIXED

**Status**: The SDK now generates method implementations for template classes.

**Current SDK** (in `range.pxd` and `hexrays.pxd`):

```cython
cdef cppclass qvector[T]:
    qvector() except +
    qvector(const qvector[T]& x) except +
    T& operator[](size_t idx)
    T& at(size_t idx)
    T& front()
    T& back()
    size_t size() const
    bint empty() const
    size_t capacity() const
    void reserve(size_t cnt) except +
    void push_back(const T& x) except +
    void pop_back() except +
    void clear() except +
    void resize(size_t newsize) except +
    void swap(qvector[T]& r) except +
    # ... iterators, erase, insert, find, has, add_unique
```

**No longer a gap** - manual `_chexrays.pxd` still has more methods but SDK is sufficient for most use cases.

### 2. mop_t Class Definition ✅ FIXED

**Status**: The SDK now generates the complete `mop_t` class with all fields and methods.

**SDK hexrays.pxd (lines 5845-5895)**:
```cython
cdef cppclass mop_t:
    mopt_t t           # Operand type
    uint8 oprops       # Operand properties
    uint16 valnum      # Value number
    int size           # Operand size
    # Union members for different operand types:
    mreg_t r           # mop_r   register number
    mnumber_t* nnn     # mop_n   immediate value
    minsn_t* d         # mop_d   result of another instruction
    stkvar_ref_t* s    # mop_S   stack variable
    ea_t g             # mop_v   global variable
    int b              # mop_b   block number
    mcallinfo_t* f     # mop_f   function call information
    lvar_ref_t* l      # mop_l   local variable
    mop_addr_t* a      # mop_a   address operand
    char* helper       # mop_h   helper function name
    char* cstr         # mop_str utf8 string constant
    mcases_t* c        # mop_c   cases
    fnumber_t* fpc     # mop_fn  floating point constant
    mop_pair_t* pair   # mop_p   operand pair
    scif_t* scif       # mop_sc  scattered operand info
    # Methods (50+ including):
    mop_t()
    mop_t& assign(mop_t& rop)
    char* dstr() const
    void make_number(uint64 _value, int _size, ea_t _ea, int opnum)
    bint is_reg() const
    bint is_insn() const
    bint equal_mops(mop_t& rop, int eqflags) const
    # ... and many more
```

**No longer a gap** - SDK now has complete `mop_t` definition suitable for microcode manipulation.

### 3. Struct Fields ✅ FIXED

**Status**: The SDK now generates complete struct definitions including previously missing fields.

**SDK mcallinfo_t (lines 6009-6037)** - now complete:
```cython
cdef cppclass mcallinfo_t:
    ea_t callee              # address of the called function
    int solid_args           # number of solid args
    int call_spd             # sp value at call insn
    int stkargs_top          # first offset past stack arguments
    callcnv_t cc             # calling convention
    mcallargs_t args         # ✅ NOW INCLUDED - call arguments
    mopvec_t retregs         # return register(s)
    tinfo_t return_type      # type of returned value
    argloc_t return_argloc   # location of returned value
    mlist_t return_regs      # list of values returned
    mlist_t spoiled          # list of spoiled locations
    mlist_t pass_regs        # passthrough registers
    ivlset_t visible_memory  # what memory is visible to call
    mlist_t dead_regs        # defined but never used registers
    int flags                # combination of bits
    funcrole_t role          # function role
    type_attrs_t fti_attrs   # extended function attributes
```

**No longer a gap** - SDK now has complete `mcallinfo_t` definition with `args` field.

### 4. Custom Helper Functions

**Problem**: SWIG interop requires custom C++ helper code not present in SDK headers.

**Required Helpers**:

| Helper | Purpose | Location |
|--------|---------|----------|
| `_swig_ptr()` | Extract C++ pointer from Python SWIG object | _chexrays.pxd:420 |
| `swigtocpp<T>()` | Template for SWIG-to-C++ conversion | swigpyobject.h |
| `SwigPyObject` | SWIG internal struct definition | swigpyobject.h |

**Example**:

```cython
# Manual helper in _chexrays.pxd:
cdef inline void* _swig_ptr(object obj):
    addr = PyObject_GetAttrString(obj, "this")
    return (<SwigPyObjectPtr>addr).ptr
```

**Generator Status**: These cannot be auto-generated; they must remain in manual definitions.

### 5. Custom Enums (Manual by Design)

**Status**: These enums are Cython conveniences, not SDK gaps. The SDK correctly exposes the underlying types.

**Custom Enums in `_chexrays.pxd`**:

| Enum | Purpose | SDK Equivalent |
|------|---------|----------------|
| `MOPT` | Named operand type constants | `mopt_t` (uint8) - correct |
| `OPERAND_PROPERTIES` | Named property flags | `oprops` field (uint8) - correct |
| `LOCOPT_FLAGS` | Named optimization flags | Integer flags - correct |

**Example**:

```cython
# Cython convenience enum in _chexrays.pxd:
cdef enum MOPT:
    ZERO          = 0   # Matches mop_z value
    REGISTER      = 1   # Matches mop_r value
    NUMBER        = 2   # Matches mop_n value
    # ... etc
```

**No generator change needed** - these are intentional conveniences for D810 code readability.

### 6. Method Signature Corrections

**Problem**: Some methods have incorrect or simplified signatures in SDK.

**Affected Methods**:

| Method | SDK Signature | Correct Signature |
|--------|---------------|-------------------|
| `mop_t.make_number` | Various overloads | `make_number(uint64 val, int size)` |

**Generator Improvement**: Better overload resolution and default argument handling.

### 7. Typedef Aliases

**Problem**: Common typedefs need to be available at Cython level.

**Required Typedefs**:

```cython
# Common container types
ctypedef _qstring[char] qstring
ctypedef qvector[qstring] qstrvec_t
ctypedef qvector[int] intvec_t
ctypedef qvector[bint] boolvec_t
ctypedef qvector[size_t] sizevec_t
ctypedef qvector[uchar] bytevec_t

# Hex-Rays specific
ctypedef qvector[mcallarg_t] mcallargs_t
ctypedef qvector[mop_t] mopvec_t
```

**Generator Status**: Most are in SDK but may use different names.

## Migration Path

To migrate from manual `_chexrays.pxd` to SDK-generated files:

### Phase 1: Template Classes ✅ COMPLETE
1. ~~Enhance generator to parse full template definitions~~
2. ~~Verify `qvector` and `_qstring` methods compile~~
3. ~~Run equivalence tests~~

### Phase 2: Struct Fields ✅ COMPLETE
1. ~~Audit all struct fields in manual file vs SDK~~
2. ~~Fix generator for missing fields~~
3. ~~Verify field access compiles~~

SDK now has complete definitions for `mop_t`, `mcallinfo_t`, and other critical types.

### Phase 3: Custom Enums (Manual by Design)

Custom enums (`MOPT`, `OPERAND_PROPERTIES`, `LOCOPT_FLAGS`) are Cython conveniences, not SDK gaps.
These will remain in `_chexrays.pxd` as they provide readable named constants for D810 code.

### Phase 4: Helpers (Manual - By Design)
1. Keep `swigpyobject.h` and SWIG helpers separate
2. Create `_helpers.pxd` for custom code
3. Import helpers alongside SDK types

## Testing

Equivalence testing between SDK and manual definitions:

```python
# tests/unit/test_pxd_equivalence.py
def test_mop_t_field_equivalence():
    """Verify SDK mop_t has same fields as manual."""
    # Test that all union members exist
    # Test that field offsets match
```

## Files Reference

| File | Purpose |
|------|---------|
| `sdk/hexrays.pxd` | Auto-generated Hex-Rays types |
| `sdk/pro.pxd` | Auto-generated basic types (ea_t, etc.) |
| `_chexrays.pxd` | Manual definitions with gaps filled |
| `_chexrays_api.pyx` | Cython implementation using above |
| `swigpyobject.h` | SWIG interop header (manual) |

## Related Issues

- `d810ng-sm4`: Migrate to SDK-generated pxd files
- `d810ng-duc`: This documentation (SDK pxd gaps)

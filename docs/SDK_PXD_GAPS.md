# SDK PXD Gaps Documentation

This document catalogs the gaps between auto-generated SDK `.pxd` files and the manual `_chexrays.pxd` definitions, enabling future improvements to the pxd generator.

> **Last Updated**: 2025-11-30

## Overview

D810's Cython bindings use two approaches:

1. **Auto-generated SDK files** (`src/d810/speedups/cythxr/sdk/`)
   - Generated by `pxdgen` from IDA SDK headers
   - Contain basic type definitions and class stubs
   - May have incomplete methods, wrong signatures, or missing fields

2. **Manual definitions** (`src/d810/speedups/cythxr/_chexrays.pxd`)
   - Hand-crafted to fill gaps in SDK files
   - Contains full template definitions, custom helpers, and fixes
   - Currently required for correct Cython compilation

## Current Status Summary

| Gap Category | Status | Notes |
|--------------|--------|-------|
| Template classes (qvector, _qstring) | ✅ FIXED | SDK now has ~20 methods each |
| mop_t class definition | ❌ CRITICAL | SDK has only `pass`, no fields |
| mcallinfo_t.args field | ❌ Missing | Needed for call analysis |
| MOPT enum (mop_zero, mop_r, etc.) | ❌ Missing | Must define manually |
| OPERAND_PROPERTIES enum | ❌ Missing | Must define manually |
| LOCOPT_FLAGS enum | ❌ Missing | Must define manually |
| SWIG helpers | Manual by design | Cannot be auto-generated |

## Gap Categories

### 1. Template Class Definitions ✅ FIXED

**Status**: The SDK now generates method implementations for template classes.

**Current SDK** (in `range.pxd` and `hexrays.pxd`):

```cython
cdef cppclass qvector[T]:
    qvector() except +
    qvector(const qvector[T]& x) except +
    T& operator[](size_t idx)
    T& at(size_t idx)
    T& front()
    T& back()
    size_t size() const
    bint empty() const
    size_t capacity() const
    void reserve(size_t cnt) except +
    void push_back(const T& x) except +
    void pop_back() except +
    void clear() except +
    void resize(size_t newsize) except +
    void swap(qvector[T]& r) except +
    # ... iterators, erase, insert, find, has, add_unique
```

**No longer a gap** - manual `_chexrays.pxd` still has more methods but SDK is sufficient for most use cases.

### 2. mop_t Class Definition ❌ CRITICAL GAP

**Problem**: The SDK generates `mop_t` as a forward declaration only, with no fields or methods.

**SDK hexrays.pxd (line 4263)**:
```cython
cdef cppclass mop_t:  # Microcode level forward definitions:
    pass  # ← ONLY THIS! No fields, no methods!
```

**Manual _chexrays.pxd requires**:
```cython
cdef cppclass mop_t:
    mop_t() except +
    mopt_t t           # Operand type
    uint8 oprops       # Operand properties
    uint16 valnum      # Value number
    int size           # Operand size
    # Union members for different operand types:
    mreg_t r           # Register
    mnumber_t *nnn     # Number
    minsn_t *d         # Sub-instruction
    stkvar_ref_t *s    # Stack variable
    ea_t g             # Global address
    int b              # Block number
    mcallinfo_t *f     # Call info
    lvar_ref_t *l      # Local variable
    mop_addr_t *a      # Address operand
    char *helper       # Helper function
    char *cstr         # String constant
    mcases_t *c        # Cases
    fnumber_t *fpc     # Floating point
    mop_pair_t *pair   # Pair operand
    scif_t *scif       # Scattered
    # Methods:
    const char *dstr() const
    void make_number(uint64 val, int size)
    void assign(const mop_t& other)
```

**Impact**: Cannot use SDK for any microcode operand manipulation without manual definitions.

**Generator Fix Required**: Parse the full `mop_t` class definition from hexrays.hpp.

### 3. Missing Struct Fields

**Problem**: Some struct fields are missing from SDK-generated definitions.

**Affected Types**:

| Type | Missing Field | Notes |
|------|---------------|-------|
| `mcallinfo_t` | `args` (`mcallargs_t`) | Critical for call analysis |

**SDK mcallinfo_t (has most fields but missing args)**:
```cython
cdef cppclass mcallinfo_t:
    ea_t callee
    int solid_args
    int call_spd
    int stkargs_top
    callcnv_t cc
    int flags
    funcrole_t role
    # args field missing!
```

**Manual fix adds**:
```cython
cdef cppclass mcallinfo_t:
    mcallargs_t args  # Added manually - list of call arguments
```

**Generator Improvement**: Ensure all public fields are parsed from header structs.

### 4. Custom Helper Functions

**Problem**: SWIG interop requires custom C++ helper code not present in SDK headers.

**Required Helpers**:

| Helper | Purpose | Location |
|--------|---------|----------|
| `_swig_ptr()` | Extract C++ pointer from Python SWIG object | _chexrays.pxd:420 |
| `swigtocpp<T>()` | Template for SWIG-to-C++ conversion | swigpyobject.h |
| `SwigPyObject` | SWIG internal struct definition | swigpyobject.h |

**Example**:

```cython
# Manual helper in _chexrays.pxd:
cdef inline void* _swig_ptr(object obj):
    addr = PyObject_GetAttrString(obj, "this")
    return (<SwigPyObjectPtr>addr).ptr
```

**Generator Status**: These cannot be auto-generated; they must remain in manual definitions.

### 5. Custom Enums ❌ STILL MISSING

**Problem**: Some enums needed for Cython code aren't exposed in SDK headers or use different names.

**Required Enums**:

| Enum | Purpose | SDK Status |
|------|---------|------------|
| `MOPT` | Microcode operand type constants | Not in SDK (uses mopt_t values) |
| `OPERAND_PROPERTIES` | Operand property flags | In SDK as defines, not enum |
| `LOCOPT_FLAGS` | Local optimization flags | In SDK as defines, not enum |

**Example**:

```cython
# Manual enum in _chexrays.pxd:
cdef enum MOPT:
    ZERO          = 0
    REGISTER      = 1
    NUMBER        = 2
    # ... etc
```

**Generator Improvement**: Parse `#define` constants and generate enum equivalents.

### 6. Method Signature Corrections

**Problem**: Some methods have incorrect or simplified signatures in SDK.

**Affected Methods**:

| Method | SDK Signature | Correct Signature |
|--------|---------------|-------------------|
| `mop_t.make_number` | Various overloads | `make_number(uint64 val, int size)` |

**Generator Improvement**: Better overload resolution and default argument handling.

### 7. Typedef Aliases

**Problem**: Common typedefs need to be available at Cython level.

**Required Typedefs**:

```cython
# Common container types
ctypedef _qstring[char] qstring
ctypedef qvector[qstring] qstrvec_t
ctypedef qvector[int] intvec_t
ctypedef qvector[bint] boolvec_t
ctypedef qvector[size_t] sizevec_t
ctypedef qvector[uchar] bytevec_t

# Hex-Rays specific
ctypedef qvector[mcallarg_t] mcallargs_t
ctypedef qvector[mop_t] mopvec_t
```

**Generator Status**: Most are in SDK but may use different names.

## Migration Path

To migrate from manual `_chexrays.pxd` to SDK-generated files:

### Phase 1: Template Classes
1. Enhance generator to parse full template definitions
2. Verify `qvector` and `_qstring` methods compile
3. Run equivalence tests

### Phase 2: Struct Fields
1. Audit all struct fields in manual file vs SDK
2. Fix generator for missing fields
3. Verify field access compiles

### Phase 3: Enums and Defines
1. Parse `#define` macros into enum equivalents
2. Generate `MOPT`, `OPERAND_PROPERTIES`, etc.
3. Verify enum values match IDA SDK

### Phase 4: Helpers (Manual)
1. Keep `swigpyobject.h` and SWIG helpers separate
2. Create `_helpers.pxd` for custom code
3. Import helpers alongside SDK types

## Testing

Equivalence testing between SDK and manual definitions:

```python
# tests/unit/test_pxd_equivalence.py
def test_mop_t_field_equivalence():
    """Verify SDK mop_t has same fields as manual."""
    # Test that all union members exist
    # Test that field offsets match
```

## Files Reference

| File | Purpose |
|------|---------|
| `sdk/hexrays.pxd` | Auto-generated Hex-Rays types |
| `sdk/pro.pxd` | Auto-generated basic types (ea_t, etc.) |
| `_chexrays.pxd` | Manual definitions with gaps filled |
| `_chexrays_api.pyx` | Cython implementation using above |
| `swigpyobject.h` | SWIG interop header (manual) |

## Related Issues

- `d810ng-sm4`: Migrate to SDK-generated pxd files
- `d810ng-duc`: This documentation (SDK pxd gaps)

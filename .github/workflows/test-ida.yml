name: Test with IDA Pro

on:
  push:
    branches: [ main, master, claude/* ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        ida-version: ['8.4']
        python-version: ['3.11']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache IDA Pro
      id: cache-ida
      uses: actions/cache@v3
      with:
        path: ~/idapro
        key: ${{ runner.os }}-ida-${{ matrix.ida-version }}

    - name: Download and install IDA Pro
      if: steps.cache-ida.outputs.cache-hit != 'true'
      env:
        IDA_VERSION: ${{ matrix.ida-version }}
      run: |
        # This would download IDA Pro (requires credentials/license)
        # For now, this is a placeholder - you'll need to set up IDA_DOWNLOAD_URL
        # and IDA_LICENSE as repository secrets
        echo "IDA Pro installation would happen here"
        echo "Set IDA_DOWNLOAD_URL and IDA_LICENSE in repository secrets"

        # Example installation steps:
        # wget -O ida.run "$IDA_DOWNLOAD_URL"
        # chmod +x ida.run
        # ./ida.run --mode unattended --prefix ~/idapro

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov z3-solver typing-extensions
        pip install -e .

    - name: Run syntax checks
      run: |
        python -m py_compile src/d810/optimizers/dsl.py
        python -m py_compile src/d810/optimizers/rules.py
        python -m py_compile src/d810/optimizers/microcode/instructions/pattern_matching/rewrite_add_refactored.py
        python -m py_compile tests/unit/optimizers/test_dsl_extensions.py

    - name: Run tests without IDA (syntax and structure only)
      run: |
        # These tests don't require IDA
        python -c "
        import sys
        import ast

        # Verify all Python files have valid syntax
        test_files = [
            'src/d810/optimizers/dsl.py',
            'src/d810/optimizers/rules.py',
            'src/d810/optimizers/microcode/instructions/pattern_matching/rewrite_add_refactored.py',
            'tests/unit/optimizers/test_dsl_extensions.py',
        ]

        for filepath in test_files:
            with open(filepath) as f:
                try:
                    ast.parse(f.read())
                    print(f'✓ {filepath} syntax OK')
                except SyntaxError as e:
                    print(f'✗ {filepath} syntax error: {e}')
                    sys.exit(1)

        print('')
        print('All syntax checks passed!')
        "

    - name: Run IDA Pro headless tests
      if: steps.cache-ida.outputs.cache-hit == 'true'
      env:
        IDADIR: ~/idapro
        IDALOG: /tmp/ida.log
      run: |
        # Run IDA Pro in headless mode to execute tests
        ~/idapro/idat64 -A -S"$PWD/tests/run_tests.py" -L"$IDALOG" &
        IDA_PID=$!

        # Wait for tests to complete (with timeout)
        timeout 300 tail -f "$IDALOG" || true

        # Check if tests passed
        if grep -q "TESTS PASSED" "$IDALOG"; then
          echo "✓ All IDA Pro tests passed!"
          exit 0
        else
          echo "✗ IDA Pro tests failed!"
          cat "$IDALOG"
          exit 1
        fi

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results-${{ matrix.ida-version }}
        path: |
          /tmp/ida.log
          coverage.xml
          htmlcov/

    - name: Report coverage
      if: always()
      run: |
        if [ -f coverage.xml ]; then
          pip install coverage
          coverage report
        fi
